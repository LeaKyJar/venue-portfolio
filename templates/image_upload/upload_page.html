<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Venue</title>
</head>
<body>
<input type="file" id="file_input"/>
<p id="status">Please select an image</p>


<button type="button" id="submit_button" onClick="getSignedRequest()">Upload image</button>
</body>

<script>
/*
(function() {
    document.getElementById("file_input").onchange = function(){
        var files = document.getElementById("file_input").files;
        var file = files[0];
        if(!file){
          return alert("No file selected.");
        }
        getSignedRequest(file);
    };
})();
*/

function getSignedRequest(){
    var xhr = new XMLHttpRequest();
    var files = document.getElementById("file_input").files;
    var file = files[0];
    if (!file){
        return alert("No file selected.")
    }
    xhr.open("GET", "/upload/sign_s3?file_name="+file.name+"&file_type="+file.type);
    xhr.onreadystatechange = function(){
    if(xhr.readyState === 4){
      if(xhr.status === 200){
        var response = JSON.parse(xhr.responseText);
        uploadFile(file, response.data, response.url);
      }
      else{
        alert("Could not get signed URL.");
      }
    }
    };
    xhr.send();
}

function uploadFile(file, s3Data, url){
    var xhr = new XMLHttpRequest();
    xhr.open("POST", s3Data.url);
    document.getElementById("submit_button").innerHTML = "Uploading..."
    var postData = new FormData();
    for(key in s3Data.fields){
    postData.append(key, s3Data.fields[key]);
    }
    postData.append('file', file);

    xhr.onreadystatechange = function() {
    if(xhr.readyState === 4){
      if(xhr.status === 200 || xhr.status === 204){
        document.getElementById("submit_button").innerHTML = "Upload image";
        alert("Upload successful");
      }
      else{
        alert("Could not upload file.");
      }
    }
    };
    xhr.send(postData);
}
</script>
</html>